# Story 1.4: Multi-Role User Profiles & Admin Access

## Status
Draft

## Story
**As a** registered user,  
**I want** role-specific profiles with appropriate features and admin oversight,  
**so that** I can manage my account and administrators can oversee the platform.

## Acceptance Criteria

1. **Role-Specific Profiles**: Custom profile fields for each role (location for customers, business info for print shops, bio for creators)
2. **Profile Management**: Responsive profile editing with image upload to Cloudflare R2
3. **Verification System**: Print shop business document upload and admin approval workflow
4. **Admin Authentication**: Special admin role with access to user management interfaces
5. **Account Settings**: Password changes, email preferences, notification settings, and account deactivation
6. **Data Validation**: Comprehensive form validation with clear error messages and requirements
7. **Privacy Controls**: User settings for public profile visibility and data sharing preferences

## Tasks / Subtasks

- [ ] **Task 1: Role-Specific Profile Components** (AC: 1)
  - [ ] Create customer profile component with location fields
  - [ ] Create creator profile component with bio and specializations
  - [ ] Create print shop profile component with business information
  - [ ] Implement dynamic form rendering based on user role
  - [ ] Add profile completion indicators and progress bars

- [ ] **Task 2: Profile Image Upload Integration** (AC: 2)
  - [ ] Create profile image upload component using Cloudflare R2
  - [ ] Implement image cropping and resizing functionality
  - [ ] Add drag-and-drop profile image upload
  - [ ] Create avatar display component with fallbacks
  - [ ] Implement image validation (size, format, content)

- [ ] **Task 3: Print Shop Verification System** (AC: 3)
  - [ ] Create business document upload interface
  - [ ] Implement verification status tracking
  - [ ] Build admin approval workflow interface
  - [ ] Add verification badge display for verified shops
  - [ ] Create email notifications for verification status changes

- [ ] **Task 4: Admin User Management Interface** (AC: 4)
  - [ ] Create admin dashboard with user overview
  - [ ] Build user search and filtering functionality
  - [ ] Implement user role management (promote/demote)
  - [ ] Add user account suspension/activation controls
  - [ ] Create audit log for admin actions

- [ ] **Task 5: Account Settings Management** (AC: 5)
  - [ ] Create password change form with validation
  - [ ] Build email preference management interface
  - [ ] Implement notification settings (email, push, SMS)
  - [ ] Add account deactivation flow with confirmation
  - [ ] Create data export functionality for user data

- [ ] **Task 6: Form Validation and Error Handling** (AC: 6)
  - [ ] Implement comprehensive Zod validation schemas
  - [ ] Create real-time form validation with error display
  - [ ] Add field-specific validation messages
  - [ ] Implement form state management and persistence
  - [ ] Add loading states and submission feedback

- [ ] **Task 7: Privacy and Visibility Controls** (AC: 7)
  - [ ] Create profile visibility settings (public/private/limited)
  - [ ] Implement data sharing preference controls
  - [ ] Add consent management for data collection
  - [ ] Create privacy dashboard with data usage overview
  - [ ] Implement GDPR compliance features

- [ ] **Task 8: Profile System Testing**
  - [ ] Test role-specific profile creation and editing
  - [ ] Test admin verification workflows
  - [ ] Test privacy controls and data visibility
  - [ ] Test form validation and error handling
  - [ ] Test responsive design across devices

## Dev Notes

### Previous Story Insights
**Dependencies from Previous Stories:**
- Story 1.1: User collection schema with role-based profile fields
- Story 1.2: NextAuth.js authentication, Cloudflare R2 file upload system
- Story 1.3: Responsive UI components and navigation patterns

### User Schema Profile Integration
[Source: complete-architecture/database-architecture.md#users-collection]

**Role-Specific Profile Fields:**
```typescript
interface User {
  _id: ObjectId
  email: string (unique, required)
  name?: string
  image?: string
  role: 'customer' | 'creator' | 'printShop' | 'admin'
  emailVerified?: Date
  
  profile?: {
    // Customer fields
    location?: {
      address: string
      city: string
      coordinates: [number, number] // [lng, lat]
    }
    
    // Creator fields
    bio?: string
    specializations?: string[]
    portfolio?: string[]
    
    // Print Shop fields
    businessInfo?: {
      name: string
      description: string
      capabilities: string[]
      equipment: string[]
      hours: {
        [day: string]: { open: string; close: string }
      }
      pricing: {
        [service: string]: number
      }
    }
    isVerified?: boolean
  }
  
  preferences: {
    notifications: {
      email: boolean
      orderUpdates: boolean
      marketing: boolean
    }
  }
  
  createdAt: Date
  updatedAt: Date
}
```

### Authentication and Role-Based Access
[Source: complete-architecture/authentication-architecture.md#role-based-access-control]

**Middleware Protection for Admin Routes:**
```typescript
// middleware.ts extension for profile routes
export default auth((req) => {
  const { pathname } = req.nextUrl
  const userRole = req.auth?.user?.role

  // Admin routes
  if (pathname.startsWith('/admin')) {
    if (userRole !== 'admin') {
      return NextResponse.redirect(new URL('/unauthorized', req.url))
    }
  }

  // Profile management - users can only edit own profiles
  if (pathname.startsWith('/profile/edit')) {
    if (!req.auth?.user) {
      return NextResponse.redirect(new URL('/auth/signin', req.url))
    }
  }

  return NextResponse.next()
})
```

### File Upload Architecture Integration
[Source: complete-architecture/file-management-architecture.md#cloudflare-r2-integration]

**Profile Image Upload API Pattern:**
```typescript
// /api/profile/upload-image/route.ts
export async function POST(request: NextRequest) {
  const session = await auth()
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }

  const { fileName, fileType, fileSize } = await request.json()
  
  // Validate image file
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp']
  const maxSize = 5 * 1024 * 1024 // 5MB for profile images
  
  if (!allowedTypes.includes(fileType) || fileSize > maxSize) {
    return NextResponse.json({ error: "Invalid image file" }, { status: 400 })
  }

  // Generate unique key for profile image
  const key = `profiles/${session.user.id}/avatar-${Date.now()}-${fileName}`
  
  const uploadUrl = await generatePresignedUploadUrl(key, fileType)
  
  return NextResponse.json({
    uploadUrl,
    key,
    cdnUrl: getCDNUrl(key)
  })
}
```

### Component Architecture for Profiles
[Source: complete-architecture/component-architecture.md#base-component-library-structure]

**Profile Component Structure:**
```
components/
├── profile/
│   ├── customer-profile-form.tsx
│   ├── creator-profile-form.tsx
│   ├── printshop-profile-form.tsx
│   ├── profile-image-upload.tsx
│   ├── account-settings.tsx
│   └── privacy-controls.tsx
├── admin/
│   ├── user-management.tsx
│   ├── verification-queue.tsx
│   ├── admin-dashboard.tsx
│   └── audit-log.tsx
└── forms/
    ├── profile-form.tsx
    ├── business-verification-form.tsx
    └── settings-form.tsx
```

### Form Architecture and Validation
[Source: complete-architecture/form-architecture.md#multi-step-form-components]

**Zod Validation Schemas for Role-Specific Profiles:**
```typescript
// lib/validations/profile.ts
import { z } from "zod"

export const customerProfileSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters"),
  location: z.object({
    address: z.string().min(5, "Please enter a valid address"),
    city: z.string().min(2, "Please enter a valid city"),
    coordinates: z.array(z.number()).length(2).optional()
  }).optional()
})

export const creatorProfileSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters"),
  bio: z.string().max(500, "Bio must be less than 500 characters").optional(),
  specializations: z.array(z.string()).max(10, "Maximum 10 specializations"),
  portfolio: z.array(z.string().url("Invalid portfolio URL")).max(5, "Maximum 5 portfolio items")
})

export const printShopProfileSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters"),
  businessInfo: z.object({
    name: z.string().min(2, "Business name is required"),
    description: z.string().max(1000, "Description must be less than 1000 characters"),
    capabilities: z.array(z.string()).min(1, "At least one capability required"),
    equipment: z.array(z.string()).min(1, "At least one equipment item required"),
    hours: z.record(z.object({
      open: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/, "Invalid time format"),
      close: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/, "Invalid time format")
    })),
    pricing: z.record(z.number().positive("Pricing must be positive"))
  })
})
```

### Admin Interface Architecture
**Admin Dashboard Components:**
```typescript
// components/admin/user-management.tsx
interface UserManagementProps {
  users: User[]
  onRoleChange: (userId: string, newRole: string) => void
  onStatusChange: (userId: string, status: 'active' | 'suspended') => void
}

export function UserManagement({ users, onRoleChange, onStatusChange }: UserManagementProps) {
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">User Management</h2>
        <div className="flex gap-2">
          <Button variant="outline">Export Users</Button>
          <Button>Create Admin</Button>
        </div>
      </div>
      
      <DataTable
        columns={userColumns}
        data={users}
        searchKey="email"
        actions={{
          onRoleChange,
          onStatusChange
        }}
      />
    </div>
  )
}
```

### File Locations and Project Structure
- **Profile Pages**: `/app/profile/page.tsx`, `/app/profile/edit/page.tsx`
- **Admin Pages**: `/app/admin/users/page.tsx`, `/app/admin/verification/page.tsx`
- **Profile Components**: `/components/profile/` directory
- **Admin Components**: `/components/admin/` directory
- **API Routes**: `/app/api/profile/`, `/app/api/admin/`
- **Validation Schemas**: `/lib/validations/profile.ts`

### API Routes Structure
```
/api/
├── profile/
│   ├── route.ts                 # GET, PUT profile data
│   ├── upload-image/route.ts    # Profile image upload
│   └── settings/route.ts        # Account settings
├── admin/
│   ├── users/route.ts           # User management
│   ├── verification/route.ts    # Business verification
│   └── audit/route.ts           # Admin audit logs
```

### Business Verification Workflow
**Verification States and Process:**
1. **Unverified**: New print shop registration
2. **Pending**: Documents uploaded, awaiting admin review
3. **Verified**: Admin approved, full platform access
4. **Rejected**: Admin rejected, can resubmit with corrections

**Required Business Documents:**
- Business license or registration
- Tax identification number
- Proof of business address
- Equipment photos/specifications
- Insurance documentation (optional)

### Privacy and GDPR Compliance
**Privacy Control Features:**
- Profile visibility settings (public, private, business only)
- Data sharing consent management
- Right to data portability (export)
- Right to be forgotten (account deletion)
- Audit trail of data access and modifications

### Environment Variables Required
```bash
# Existing from previous stories
MONGODB_URI=mongodb+srv://...
NEXTAUTH_SECRET=your-secret-key
R2_ACCESS_KEY_ID=your-access-key
R2_SECRET_ACCESS_KEY=your-secret-key
R2_BUCKET_NAME=printing-marketplace

# Profile-specific
ADMIN_EMAIL=admin@yourdomain.com
MAX_PROFILE_IMAGE_SIZE=5242880  # 5MB
VERIFICATION_WEBHOOK_URL=https://...
```

### Security Considerations
- **Data Validation**: Comprehensive Zod schemas for all profile data
- **File Upload Security**: Image format validation, virus scanning
- **Admin Access Control**: Multiple admin role levels if needed
- **Audit Logging**: Track all admin actions and profile changes
- **Rate Limiting**: Prevent profile update abuse

## Testing

### Test Requirements
[Source: complete-architecture/testing-strategy.md#component-testing]

**Profile Component Testing:**
```typescript
// __tests__/components/profile/creator-profile-form.test.tsx
describe('CreatorProfileForm', () => {
  it('renders creator-specific fields', () => {
    render(<CreatorProfileForm user={mockCreatorUser} />)
    
    expect(screen.getByLabelText('Bio')).toBeInTheDocument()
    expect(screen.getByLabelText('Specializations')).toBeInTheDocument()
    expect(screen.getByText('Portfolio URLs')).toBeInTheDocument()
  })

  it('validates bio length and shows error', async () => {
    render(<CreatorProfileForm user={mockCreatorUser} />)
    
    const bioField = screen.getByLabelText('Bio')
    fireEvent.change(bioField, { 
      target: { value: 'a'.repeat(501) } // Over 500 char limit
    })
    
    await waitFor(() => {
      expect(screen.getByText('Bio must be less than 500 characters')).toBeInTheDocument()
    })
  })
})
```

**Admin Interface Testing:**
```typescript
// __tests__/components/admin/user-management.test.tsx
describe('UserManagement', () => {
  it('displays user list with role and status', () => {
    render(<UserManagement users={mockUsers} />)
    
    expect(screen.getByText('test@example.com')).toBeInTheDocument()
    expect(screen.getByText('Creator')).toBeInTheDocument()
    expect(screen.getByText('Active')).toBeInTheDocument()
  })

  it('allows admin to change user roles', async () => {
    const mockRoleChange = jest.fn()
    render(<UserManagement users={mockUsers} onRoleChange={mockRoleChange} />)
    
    fireEvent.click(screen.getByText('Change Role'))
    fireEvent.click(screen.getByText('Print Shop'))
    
    expect(mockRoleChange).toHaveBeenCalledWith('user-123', 'printShop')
  })
})
```

**API Route Testing:**
```typescript
// __tests__/api/profile.test.ts
describe('/api/profile', () => {
  it('updates user profile with valid data', async () => {
    const response = await PUT('/api/profile', {
      name: 'Updated Name',
      profile: {
        bio: 'Updated bio for creator'
      }
    })
    
    expect(response.status).toBe(200)
    expect(response.body.user.name).toBe('Updated Name')
  })

  it('rejects invalid profile data', async () => {
    const response = await PUT('/api/profile', {
      name: '', // Invalid empty name
      profile: {
        bio: 'a'.repeat(501) // Over character limit
      }
    })
    
    expect(response.status).toBe(400)
    expect(response.body.errors).toBeDefined()
  })
})
```

**Business Verification Testing:**
```typescript
// __tests__/api/admin/verification.test.ts
describe('/api/admin/verification', () => {
  it('approves print shop verification', async () => {
    const response = await POST('/api/admin/verification/approve', {
      userId: 'printshop-123',
      notes: 'All documents verified'
    })
    
    expect(response.status).toBe(200)
    expect(response.body.status).toBe('verified')
  })

  it('sends email notification on verification status change', async () => {
    const emailSpy = jest.spyOn(emailService, 'sendEmail')
    
    await POST('/api/admin/verification/approve', {
      userId: 'printshop-123'
    })
    
    expect(emailSpy).toHaveBeenCalledWith(
      expect.objectContaining({
        subject: expect.stringContaining('verification')
      })
    )
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_