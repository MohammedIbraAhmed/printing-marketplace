# Story 2.5: Order Assignment & Management

## Status
Draft

## Story
**As a** print shop owner,  
**I want** to receive and manage digital orders efficiently,  
**so that** I can fulfill customer orders and maintain shop operations.

## Acceptance Criteria

1. **Order Queue**: Print shop dashboard showing incoming orders with priority sorting
2. **Order Details**: Full order information including files, specifications, and customer details
3. **Order Acceptance**: Accept or decline orders with capacity and capability validation
4. **Estimated Completion**: Provide and update estimated completion times for customers
5. **Status Management**: Update order status through workflow (Accepted, In Progress, Ready, Completed)
6. **Customer Contact**: Direct communication channel for order-specific questions
7. **Shop Analytics**: Basic metrics on order volume, completion times, and customer ratings

## Tasks / Subtasks

- [ ] **Task 1: Print Shop Order Dashboard** (AC: 1)
  - [ ] Create comprehensive order queue interface
  - [ ] Implement priority sorting (urgent, standard, bulk)
  - [ ] Build filtering system (status, date, customer, value)
  - [ ] Add real-time order notifications and updates
  - [ ] Create order summary cards with key information

- [ ] **Task 2: Detailed Order Information Display** (AC: 2)
  - [ ] Build comprehensive order detail view
  - [ ] Create file preview and download system
  - [ ] Display complete print specifications and requirements
  - [ ] Show customer contact information and preferences
  - [ ] Add order history and timeline view

- [ ] **Task 3: Order Acceptance/Decline System** (AC: 3)
  - [ ] Create order acceptance workflow interface
  - [ ] Implement capacity validation before acceptance
  - [ ] Build decline functionality with reason selection
  - [ ] Add automatic reassignment for declined orders
  - [ ] Create batch accept/decline for multiple orders

- [ ] **Task 4: Completion Time Estimation** (AC: 4)
  - [ ] Build estimation interface with time slot selection
  - [ ] Implement workload-based completion calculations
  - [ ] Create estimation update and customer notification system
  - [ ] Add holiday and business hours integration
  - [ ] Build estimation accuracy tracking

- [ ] **Task 5: Order Status Workflow Management** (AC: 5)
  - [ ] Create status update interface with workflow validation
  - [ ] Implement status transition rules and validations
  - [ ] Build progress tracking with percentage completion
  - [ ] Add status change notifications to customers
  - [ ] Create status history logging and audit trail

- [ ] **Task 6: Customer Communication System** (AC: 6)
  - [ ] Build order-specific messaging interface
  - [ ] Create quick message templates for common scenarios
  - [ ] Implement file attachment for communication
  - [ ] Add customer response notifications
  - [ ] Create communication history tracking

- [ ] **Task 7: Shop Performance Analytics** (AC: 7)
  - [ ] Build analytics dashboard for print shop owners
  - [ ] Create order volume and revenue metrics
  - [ ] Implement completion time performance tracking
  - [ ] Add customer satisfaction and rating analytics
  - [ ] Create exportable reports for business analysis

- [ ] **Task 8: Order Management Testing**
  - [ ] Test order queue and filtering functionality
  - [ ] Test acceptance/decline workflow
  - [ ] Test status management and notifications
  - [ ] Test customer communication system
  - [ ] Verify analytics accuracy and performance

## Dev Notes

### Previous Story Insights
**Dependencies from Previous Stories:**
- Story 1.1: Order collection schema with status workflow
- Story 1.5: Email notification system for order updates
- Story 2.1: Print shop profiles and capacity management
- Story 2.4: Order creation system and order structure

### Print Shop Dashboard Architecture
**Order Management Interface:**
```typescript
// components/shop/order-dashboard.tsx
interface OrderDashboardProps {
  shopId: string
}

export function OrderDashboard({ shopId }: OrderDashboardProps) {
  const [orders, setOrders] = useState<Order[]>([])
  const [filters, setFilters] = useState<OrderFilters>({
    status: 'all',
    priority: 'all',
    dateRange: 'all'
  })
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null)

  // Real-time order updates
  useEffect(() => {
    const eventSource = new EventSource(`/api/shop/orders/stream?shopId=${shopId}`)
    
    eventSource.onmessage = (event) => {
      const orderUpdate = JSON.parse(event.data)
      setOrders(prev => updateOrderInList(prev, orderUpdate))
    }

    return () => eventSource.close()
  }, [shopId])

  const priorityOrder = ['urgent', 'standard', 'bulk']
  const statusOrder = ['pending', 'accepted', 'in_progress', 'ready']

  const sortedOrders = useMemo(() => {
    return orders
      .filter(order => applyFilters(order, filters))
      .sort((a, b) => {
        // Sort by priority first, then by creation date
        const priorityDiff = priorityOrder.indexOf(a.priority) - priorityOrder.indexOf(b.priority)
        if (priorityDiff !== 0) return priorityDiff
        
        const statusDiff = statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status)
        if (statusDiff !== 0) return statusDiff
        
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
      })
  }, [orders, filters])

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-screen">
      {/* Order Queue */}
      <div className="lg:col-span-2 space-y-4">
        <div className="flex justify-between items-center">
          <h2 className="text-2xl font-bold">Order Queue</h2>
          <div className="flex gap-2">
            <OrderFilters filters={filters} onChange={setFilters} />
            <Button size="sm" variant="outline">
              <RotateCcw className="w-4 h-4 mr-2" />
              Refresh
            </Button>
          </div>
        </div>

        <div className="space-y-3 overflow-y-auto">
          {sortedOrders.map(order => (
            <OrderQueueCard
              key={order._id}
              order={order}
              isSelected={selectedOrder?._id === order._id}
              onClick={() => setSelectedOrder(order)}
              onAccept={() => handleOrderAccept(order._id)}
              onDecline={() => handleOrderDecline(order._id)}
              onStatusUpdate={(status) => handleStatusUpdate(order._id, status)}
            />
          ))}
        </div>
      </div>

      {/* Order Details Panel */}
      <div>
        {selectedOrder ? (
          <OrderDetailPanel
            order={selectedOrder}
            onStatusUpdate={handleStatusUpdate}
            onCommunicate={handleCustomerCommunication}
            onEstimateUpdate={handleEstimateUpdate}
          />
        ) : (
          <div className="bg-gray-50 rounded-lg p-8 text-center">
            <Package className="w-12 h-12 mx-auto text-gray-400 mb-4" />
            <p className="text-gray-600">Select an order to view details</p>
          </div>
        )}
      </div>
    </div>
  )
}
```

### Order Status Management System
**Status Workflow Implementation:**
```typescript
// lib/orders/status-management.ts
export const ORDER_STATUS_WORKFLOW = {
  pending: {
    allowedTransitions: ['accepted', 'declined'],
    requiredFields: [],
    notifications: ['customer', 'admin']
  },
  accepted: {
    allowedTransitions: ['in_progress', 'cancelled'],
    requiredFields: ['estimatedCompletion'],
    notifications: ['customer', 'creator']
  },
  in_progress: {
    allowedTransitions: ['ready', 'cancelled'],
    requiredFields: ['progressPercentage'],
    notifications: ['customer']
  },
  ready: {
    allowedTransitions: ['completed', 'in_progress'],
    requiredFields: ['readyForPickup'],
    notifications: ['customer']
  },
  completed: {
    allowedTransitions: [],
    requiredFields: ['completedAt', 'qualityCheck'],
    notifications: ['customer', 'creator', 'admin']
  },
  cancelled: {
    allowedTransitions: [],
    requiredFields: ['cancellationReason'],
    notifications: ['customer', 'creator', 'admin']
  }
}

export class OrderStatusManager {
  static async updateOrderStatus(
    orderId: string, 
    newStatus: OrderStatus, 
    shopId: string,
    additionalData?: any
  ): Promise<Order> {
    const order = await Order.findById(orderId)
    if (!order) throw new Error('Order not found')
    
    if (order.printShop.shopId.toString() !== shopId) {
      throw new Error('Unauthorized to update this order')
    }

    const currentStatusConfig = ORDER_STATUS_WORKFLOW[order.status]
    if (!currentStatusConfig.allowedTransitions.includes(newStatus)) {
      throw new Error(`Cannot transition from ${order.status} to ${newStatus}`)
    }

    // Validate required fields
    const newStatusConfig = ORDER_STATUS_WORKFLOW[newStatus]
    for (const field of newStatusConfig.requiredFields) {
      if (!additionalData?.[field]) {
        throw new Error(`${field} is required for status ${newStatus}`)
      }
    }

    // Update order
    const updatedOrder = await Order.findByIdAndUpdate(
      orderId,
      {
        status: newStatus,
        ...additionalData,
        $push: {
          statusHistory: {
            status: newStatus,
            timestamp: new Date(),
            note: additionalData?.note,
            updatedBy: shopId
          }
        }
      },
      { new: true }
    )

    // Send notifications
    await this.sendStatusUpdateNotifications(updatedOrder, newStatus)

    // Update shop capacity if needed
    if (newStatus === 'completed' || newStatus === 'cancelled') {
      await this.updateShopCapacity(shopId, -1)
    }

    return updatedOrder
  }

  private static async sendStatusUpdateNotifications(order: Order, newStatus: OrderStatus) {
    const notifications = ORDER_STATUS_WORKFLOW[newStatus].notifications
    
    const notificationPromises = notifications.map(recipient => {
      switch (recipient) {
        case 'customer':
          return sendOrderStatusUpdateEmail(order, 'customer')
        case 'creator':
          return sendOrderStatusUpdateEmail(order, 'creator')
        case 'admin':
          return sendOrderStatusUpdateEmail(order, 'admin')
        default:
          return Promise.resolve()
      }
    })

    await Promise.all(notificationPromises)
  }
}
```

### Order Queue Card Component
**Interactive Order Cards:**
```typescript
// components/shop/order-queue-card.tsx
interface OrderQueueCardProps {
  order: Order
  isSelected: boolean
  onClick: () => void
  onAccept: () => void
  onDecline: () => void
  onStatusUpdate: (status: OrderStatus) => void
}

export function OrderQueueCard({ 
  order, 
  isSelected, 
  onClick, 
  onAccept, 
  onDecline, 
  onStatusUpdate 
}: OrderQueueCardProps) {
  const isPending = order.status === 'pending'
  const isOverdue = new Date() > new Date(order.printShop.confirmationDeadline)

  return (
    <Card className={cn(
      "cursor-pointer transition-all duration-200 hover:shadow-md",
      isSelected && "ring-2 ring-blue-500",
      isOverdue && "border-red-300 bg-red-50"
    )} onClick={onClick}>
      <CardContent className="p-4">
        <div className="flex justify-between items-start mb-3">
          <div>
            <div className="flex items-center gap-2">
              <h3 className="font-semibold">{order.orderNumber}</h3>
              <OrderPriorityBadge priority={order.priority} />
              <OrderStatusBadge status={order.status} />
            </div>
            <p className="text-sm text-muted-foreground">
              {order.customer.contactInfo.name} • {order.items.length} item(s)
            </p>
          </div>
          <div className="text-right">
            <p className="font-semibold">${order.pricing.total.toFixed(2)}</p>
            <p className="text-xs text-muted-foreground">
              {formatDistanceToNow(new Date(order.createdAt), { addSuffix: true })}
            </p>
          </div>
        </div>

        <div className="flex items-center gap-4 text-sm text-muted-foreground mb-3">
          <div className="flex items-center gap-1">
            <FileText className="w-4 h-4" />
            <span>{order.items.reduce((sum, item) => sum + item.specifications.quantity, 0)} copies</span>
          </div>
          <div className="flex items-center gap-1">
            <Clock className="w-4 h-4" />
            <span>
              Due: {format(new Date(order.printShop.estimatedCompletion), 'MMM d, h:mm a')}
            </span>
          </div>
          {order.delivery.method === 'delivery' && (
            <div className="flex items-center gap-1">
              <Truck className="w-4 h-4" />
              <span>Delivery</span>
            </div>
          )}
        </div>

        {/* Print Specifications Summary */}
        <div className="flex flex-wrap gap-2 mb-3">
          {order.items.map((item, index) => (
            <Badge key={index} variant="secondary" className="text-xs">
              {item.specifications.colorOption.toUpperCase()} • {item.specifications.paperSize}
              {item.specifications.binding !== 'none' && ` • ${item.specifications.binding}`}
            </Badge>
          ))}
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2">
          {isPending && (
            <>
              <Button 
                size="sm" 
                className="flex-1"
                onClick={(e) => {
                  e.stopPropagation()
                  onAccept()
                }}
              >
                Accept
              </Button>
              <Button 
                size="sm" 
                variant="outline" 
                className="flex-1"
                onClick={(e) => {
                  e.stopPropagation()
                  onDecline()
                }}
              >
                Decline
              </Button>
            </>
          )}
          
          {!isPending && (
            <StatusUpdateDropdown
              currentStatus={order.status}
              onStatusUpdate={(status) => {
                onStatusUpdate(status)
              }}
            />
          )}
        </div>

        {isOverdue && (
          <div className="mt-2 p-2 bg-red-100 border border-red-200 rounded text-xs text-red-700">
            ⚠️ Confirmation deadline passed. Auto-decline in 2 hours.
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Customer Communication System
**Order-Specific Messaging:**
```typescript
// components/shop/customer-communication.tsx
interface CustomerCommunicationProps {
  order: Order
  onMessageSent: () => void
}

export function CustomerCommunication({ order, onMessageSent }: CustomerCommunicationProps) {
  const [message, setMessage] = useState('')
  const [attachments, setAttachments] = useState<File[]>([])
  const [messageHistory, setMessageHistory] = useState<OrderMessage[]>([])
  const [isLoading, setIsLoading] = useState(false)

  const quickMessages = [
    "Your order is in progress. We'll update you when it's ready.",
    "We need clarification on your print specifications. Please call us.",
    "Your order is ready for pickup. Please bring your order confirmation.",
    "There's a slight delay. New estimated completion: [TIME]",
    "We recommend upgrading to premium paper for better quality."
  ]

  const handleSendMessage = async () => {
    if (!message.trim() && attachments.length === 0) return

    setIsLoading(true)
    try {
      const formData = new FormData()
      formData.append('orderId', order._id)
      formData.append('message', message)
      formData.append('recipientType', 'customer')
      
      attachments.forEach((file, index) => {
        formData.append(`attachment${index}`, file)
      })

      const response = await fetch('/api/orders/communicate', {
        method: 'POST',
        body: formData
      })

      if (response.ok) {
        setMessage('')
        setAttachments([])
        onMessageSent()
        fetchMessageHistory()
      }
    } catch (error) {
      console.error('Failed to send message:', error)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="space-y-4">
      <div>
        <h4 className="font-medium mb-2">Customer Communication</h4>
        <p className="text-sm text-muted-foreground">
          Communicate directly with {order.customer.contactInfo.name}
        </p>
      </div>

      {/* Message History */}
      <div className="max-h-60 overflow-y-auto space-y-2 bg-gray-50 p-3 rounded">
        {messageHistory.map((msg, index) => (
          <div key={index} className={cn(
            "p-2 rounded text-sm",
            msg.sender === 'shop' ? "bg-blue-100 ml-4" : "bg-white mr-4"
          )}>
            <p>{msg.content}</p>
            <span className="text-xs text-muted-foreground">
              {format(new Date(msg.timestamp), 'MMM d, h:mm a')}
            </span>
          </div>
        ))}
      </div>

      {/* Quick Messages */}
      <div>
        <p className="text-sm font-medium mb-2">Quick Messages:</p>
        <div className="grid grid-cols-1 gap-1">
          {quickMessages.map((quickMsg, index) => (
            <Button
              key={index}
              variant="ghost"
              size="sm"
              className="text-left justify-start h-auto p-2 text-xs"
              onClick={() => setMessage(quickMsg)}
            >
              {quickMsg}
            </Button>
          ))}
        </div>
      </div>

      {/* Message Composition */}
      <div className="space-y-3">
        <Textarea
          value={message}
          onChange={(e) => setMessage(e.target.value)}
          placeholder="Type your message to the customer..."
          className="min-h-[80px]"
        />
        
        {/* File Attachments */}
        <div className="flex items-center gap-2">
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => document.getElementById('message-attachment')?.click()}
          >
            <Paperclip className="w-4 h-4 mr-2" />
            Attach File
          </Button>
          <input
            id="message-attachment"
            type="file"
            multiple
            className="hidden"
            onChange={(e) => {
              if (e.target.files) {
                setAttachments(Array.from(e.target.files))
              }
            }}
          />
          {attachments.length > 0 && (
            <span className="text-sm text-muted-foreground">
              {attachments.length} file(s) selected
            </span>
          )}
        </div>

        <Button 
          onClick={handleSendMessage}
          disabled={isLoading || (!message.trim() && attachments.length === 0)}
          className="w-full"
        >
          {isLoading ? 'Sending...' : 'Send Message'}
        </Button>
      </div>
    </div>
  )
}
```

### Shop Analytics Dashboard
**Performance Metrics Interface:**
```typescript
// components/shop/shop-analytics.tsx
export function ShopAnalytics({ shopId }: { shopId: string }) {
  const [analytics, setAnalytics] = useState<ShopAnalytics | null>(null)
  const [timeRange, setTimeRange] = useState<'week' | 'month' | 'quarter'>('month')

  const metrics = [
    {
      title: 'Total Orders',
      value: analytics?.totalOrders || 0,
      change: analytics?.orderGrowth || 0,
      icon: Package
    },
    {
      title: 'Revenue',
      value: `$${(analytics?.revenue || 0).toFixed(2)}`,
      change: analytics?.revenueGrowth || 0,
      icon: DollarSign
    },
    {
      title: 'Avg Completion Time',
      value: `${analytics?.avgCompletionTime || 0}h`,
      change: analytics?.completionTimeChange || 0,
      icon: Clock
    },
    {
      title: 'Customer Rating',
      value: (analytics?.avgRating || 0).toFixed(1),
      change: analytics?.ratingChange || 0,
      icon: Star
    }
  ]

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">Shop Analytics</h2>
        <Select value={timeRange} onValueChange={setTimeRange}>
          <SelectTrigger className="w-32">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="week">Last Week</SelectItem>
            <SelectItem value="month">Last Month</SelectItem>
            <SelectItem value="quarter">Last Quarter</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {metrics.map((metric, index) => (
          <Card key={index}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">{metric.title}</p>
                  <p className="text-2xl font-bold">{metric.value}</p>
                  <p className={cn(
                    "text-xs",
                    metric.change >= 0 ? "text-green-600" : "text-red-600"
                  )}>
                    {metric.change >= 0 ? '+' : ''}{metric.change.toFixed(1)}% vs last period
                  </p>
                </div>
                <metric.icon className="w-8 h-8 text-muted-foreground" />
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Order Volume Chart */}
      <Card>
        <CardHeader>
          <CardTitle>Order Volume Over Time</CardTitle>
        </CardHeader>
        <CardContent>
          <OrderVolumeChart data={analytics?.orderHistory || []} />
        </CardContent>
      </Card>
    </div>
  )
}
```

### File Locations and Project Structure
- **Shop Dashboard**: `/app/shop/dashboard/page.tsx`, `/app/shop/orders/page.tsx`
- **Order Management**: `/components/shop/order-dashboard.tsx`, `/components/shop/order-queue-card.tsx`
- **Communication**: `/components/shop/customer-communication.tsx`
- **Analytics**: `/components/shop/shop-analytics.tsx`
- **API Routes**: `/app/api/shop/orders/`, `/app/api/orders/status/`, `/app/api/orders/communicate/`
- **Status Management**: `/lib/orders/status-management.ts`

## Testing

### Test Requirements
**Order Management Testing:**
```typescript
// __tests__/lib/orders/status-management.test.ts
describe('OrderStatusManager', () => {
  it('validates status transitions correctly', async () => {
    const order = await Order.create({
      status: 'pending',
      printShop: { shopId: 'shop123' }
    })

    // Valid transition
    await expect(
      OrderStatusManager.updateOrderStatus(order._id, 'accepted', 'shop123', {
        estimatedCompletion: new Date()
      })
    ).resolves.toMatchObject({ status: 'accepted' })

    // Invalid transition
    await expect(
      OrderStatusManager.updateOrderStatus(order._id, 'completed', 'shop123')
    ).rejects.toThrow('Cannot transition from accepted to completed')
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation from Epic 2 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_