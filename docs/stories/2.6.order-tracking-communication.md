# Story 2.6: Order Tracking & Communication

## Status
Draft

## Story
**As a** customer and print shop,  
**I want** real-time order status updates and communication,  
**so that** I can track progress and coordinate pickup/delivery.

## Acceptance Criteria

1. **Status Pipeline**: Clear order statuses with timestamps and progress indicators
2. **Email Notifications**: Automated email alerts for status changes using existing notification system
3. **Real-Time Updates**: Dashboard updates for order status changes and completion estimates
4. **Communication System**: Direct messaging between customers and print shops for specific orders
5. **Pickup Coordination**: Notifications when orders are ready with shop contact information
6. **Order History**: Complete history of all orders with status tracking and reorder functionality
7. **Issue Reporting**: Basic interface for reporting problems during order fulfillment

## Tasks / Subtasks

- [ ] **Task 1: Order Status Pipeline Interface** (AC: 1)
  - [ ] Create visual status progress component with timeline
  - [ ] Build status badges with color coding and icons
  - [ ] Implement progress percentage calculations
  - [ ] Add timestamp display for each status change
  - [ ] Create mobile-optimized status tracking view

- [ ] **Task 2: Automated Email Notification System** (AC: 2)
  - [ ] Integrate with existing email notification system from Story 1.5
  - [ ] Create order-specific email templates for each status
  - [ ] Implement notification preferences and unsubscribe options
  - [ ] Add email notification queue and retry logic
  - [ ] Create email notification history tracking

- [ ] **Task 3: Real-Time Dashboard Updates** (AC: 3)
  - [ ] Implement WebSocket/Server-Sent Events for live updates
  - [ ] Create real-time order status synchronization
  - [ ] Build live estimation updates and progress tracking
  - [ ] Add browser notification support for important updates
  - [ ] Implement offline capability with sync on reconnection

- [ ] **Task 4: Order Communication Interface** (AC: 4)
  - [ ] Build order-specific chat/messaging interface
  - [ ] Create message threading and conversation history
  - [ ] Implement file attachment support for messages
  - [ ] Add message status indicators (sent, delivered, read)
  - [ ] Create push notifications for new messages

- [ ] **Task 5: Pickup/Delivery Coordination** (AC: 5)
  - [ ] Create pickup notification system with QR codes
  - [ ] Build delivery tracking with estimated arrival times
  - [ ] Implement pickup reminder notifications
  - [ ] Add shop contact information and directions
  - [ ] Create delivery confirmation and proof of delivery

- [ ] **Task 6: Order History and Management** (AC: 6)
  - [ ] Build comprehensive order history interface
  - [ ] Create order search and filtering capabilities
  - [ ] Implement reorder functionality with saved preferences
  - [ ] Add order export and receipt download features
  - [ ] Create order analytics for customers (spending, frequency)

- [ ] **Task 7: Issue Reporting System** (AC: 7)
  - [ ] Create issue reporting interface with categorization
  - [ ] Build photo upload for quality issues
  - [ ] Implement issue escalation workflow
  - [ ] Add resolution tracking and follow-up notifications
  - [ ] Create issue history and resolution database

- [ ] **Task 8: Order Tracking Testing**
  - [ ] Test real-time status updates and notifications
  - [ ] Test email notification delivery and preferences
  - [ ] Test communication system functionality
  - [ ] Test pickup/delivery coordination workflow
  - [ ] Verify order history and reorder functionality

## Dev Notes

### Previous Story Insights
**Dependencies from Previous Stories:**
- Story 1.5: Email notification system and templates
- Story 2.4: Order creation and structure
- Story 2.5: Order status management and workflow

### Order Tracking Component Architecture
[Source: complete-architecture/component-architecture.md#order-status-component]

**Enhanced Order Tracker:**
```typescript
// components/orders/order-tracker.tsx
interface OrderTrackerProps {
  order: Order
  variant?: 'customer' | 'shop' | 'admin'
  showCommunication?: boolean
}

export function OrderTracker({ order, variant = 'customer', showCommunication = true }: OrderTrackerProps) {
  const [messages, setMessages] = useState<OrderMessage[]>([])
  const [isOnline, setIsOnline] = useState(true)
  
  // Real-time updates
  useEffect(() => {
    const eventSource = new EventSource(`/api/orders/${order._id}/stream`)
    
    eventSource.onmessage = (event) => {
      const update = JSON.parse(event.data)
      if (update.type === 'status_change') {
        // Update order status in parent component
        onOrderUpdate?.(update.order)
      } else if (update.type === 'new_message') {
        setMessages(prev => [...prev, update.message])
        showNotification(`New message from ${update.sender}`)
      }
    }

    eventSource.onerror = () => setIsOnline(false)
    eventSource.onopen = () => setIsOnline(true)

    return () => eventSource.close()
  }, [order._id])

  const statusSteps = [
    { 
      key: 'pending', 
      label: 'Order Placed', 
      description: 'Waiting for print shop confirmation',
      icon: Clock,
      estimatedDuration: '0-24 hours'
    },
    { 
      key: 'accepted', 
      label: 'Order Accepted', 
      description: 'Print shop confirmed your order',
      icon: CheckCircle,
      estimatedDuration: 'Same day'
    },
    { 
      key: 'in_progress', 
      label: 'Printing', 
      description: 'Your materials are being printed',
      icon: Printer,
      estimatedDuration: 'Varies by complexity'
    },
    { 
      key: 'ready', 
      label: 'Ready', 
      description: 'Order ready for pickup/delivery',
      icon: Package,
      estimatedDuration: 'Available now'
    },
    { 
      key: 'completed', 
      label: 'Completed', 
      description: 'Order delivered/picked up',
      icon: CheckCircle2,
      estimatedDuration: 'Done'
    }
  ]

  const currentStepIndex = statusSteps.findIndex(step => step.key === order.status)
  const isStepActive = (index: number) => index <= currentStepIndex
  const isStepCurrent = (index: number) => index === currentStepIndex

  return (
    <div className="space-y-6">
      {/* Connection Status */}
      {!isOnline && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          <div className="flex items-center gap-2 text-yellow-800">
            <WifiOff className="w-4 h-4" />
            <span className="text-sm">Reconnecting... Some updates may be delayed.</span>
          </div>
        </div>
      )}

      {/* Order Header */}
      <div className="flex justify-between items-start">
        <div>
          <h2 className="text-2xl font-bold">Order {order.orderNumber}</h2>
          <p className="text-muted-foreground">
            Placed {format(new Date(order.createdAt), 'PPp')}
          </p>
        </div>
        <div className="text-right">
          <OrderStatusBadge status={order.status} />
          <p className="text-sm text-muted-foreground mt-1">
            {order.printShop.estimatedCompletion && (
              <>Est. completion: {format(new Date(order.printShop.estimatedCompletion), 'PPp')}</>
            )}
          </p>
        </div>
      </div>

      {/* Status Timeline */}
      <div className="space-y-4">
        <h3 className="font-semibold">Order Progress</h3>
        <div className="space-y-4">
          {statusSteps.map((step, index) => {
            const Icon = step.icon
            const isActive = isStepActive(index)
            const isCurrent = isStepCurrent(index)
            const statusEntry = order.statusHistory.find(entry => entry.status === step.key)

            return (
              <div key={step.key} className="flex gap-4">
                <div className="flex flex-col items-center">
                  <div className={cn(
                    "w-10 h-10 rounded-full flex items-center justify-center border-2",
                    isActive 
                      ? "bg-blue-500 border-blue-500 text-white" 
                      : "bg-gray-100 border-gray-300 text-gray-400",
                    isCurrent && "ring-4 ring-blue-100"
                  )}>
                    <Icon className="w-5 h-5" />
                  </div>
                  {index < statusSteps.length - 1 && (
                    <div className={cn(
                      "w-0.5 h-16 mt-2",
                      isActive ? "bg-blue-500" : "bg-gray-200"
                    )} />
                  )}
                </div>
                
                <div className="flex-1 pb-8">
                  <div className="flex justify-between items-center">
                    <h4 className={cn(
                      "font-medium",
                      isActive ? "text-foreground" : "text-muted-foreground"
                    )}>
                      {step.label}
                    </h4>
                    {statusEntry && (
                      <time className="text-sm text-muted-foreground">
                        {format(new Date(statusEntry.timestamp), 'MMM d, h:mm a')}
                      </time>
                    )}
                  </div>
                  <p className={cn(
                    "text-sm",
                    isActive ? "text-muted-foreground" : "text-gray-400"
                  )}>
                    {step.description}
                  </p>
                  {isCurrent && (
                    <div className="mt-2">
                      <div className="flex items-center gap-2 text-sm text-blue-600">
                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse" />
                        <span>Current status â€¢ {step.estimatedDuration}</span>
                      </div>
                    </div>
                  )}
                  {statusEntry?.note && (
                    <p className="text-sm text-muted-foreground mt-1 italic">
                      "{statusEntry.note}"
                    </p>
                  )}
                </div>
              </div>
            )
          })}
        </div>
      </div>

      {/* Order Actions */}
      <OrderActionButtons 
        order={order} 
        variant={variant}
        onReorder={handleReorder}
        onReportIssue={handleReportIssue}
        onDownloadReceipt={handleDownloadReceipt}
      />

      {/* Communication Section */}
      {showCommunication && (
        <OrderCommunication 
          order={order}
          messages={messages}
          onSendMessage={handleSendMessage}
          variant={variant}
        />
      )}
    </div>
  )
}
```

### Real-Time Communication System
**Order-Specific Messaging:**
```typescript
// components/orders/order-communication.tsx
export function OrderCommunication({ order, messages, onSendMessage, variant }: OrderCommunicationProps) {
  const [newMessage, setNewMessage] = useState('')
  const [attachments, setAttachments] = useState<File[]>([])
  const [isTyping, setIsTyping] = useState(false)
  const messagesEndRef = useRef<HTMLDivElement>(null)

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }

  useEffect(() => {
    scrollToBottom()
  }, [messages])

  const handleSendMessage = async () => {
    if (!newMessage.trim() && attachments.length === 0) return

    const messageData = {
      orderId: order._id,
      content: newMessage,
      attachments: attachments,
      sender: variant
    }

    try {
      await onSendMessage(messageData)
      setNewMessage('')
      setAttachments([])
    } catch (error) {
      console.error('Failed to send message:', error)
    }
  }

  const quickReplies = variant === 'customer' ? [
    "Thank you for the update!",
    "When will my order be ready?",
    "Can I change the pickup time?",
    "I have a question about the specifications."
  ] : [
    "Your order is progressing well.",
    "We need clarification on your requirements.",
    "Your order is ready for pickup.",
    "There's a slight delay, new completion time is [TIME]."
  ]

  return (
    <div className="border rounded-lg">
      <div className="p-4 border-b">
        <h3 className="font-semibold">Order Communication</h3>
        <p className="text-sm text-muted-foreground">
          Chat directly with the {variant === 'customer' ? 'print shop' : 'customer'}
        </p>
      </div>

      {/* Messages */}
      <div className="h-80 overflow-y-auto p-4 space-y-4">
        {messages.map((message, index) => (
          <div
            key={index}
            className={cn(
              "flex",
              message.sender === variant ? "justify-end" : "justify-start"
            )}
          >
            <div className={cn(
              "max-w-[70%] rounded-lg px-3 py-2",
              message.sender === variant
                ? "bg-blue-500 text-white"
                : "bg-gray-100 text-gray-900"
            )}>
              <p className="text-sm">{message.content}</p>
              {message.attachments && message.attachments.length > 0 && (
                <div className="mt-2 space-y-1">
                  {message.attachments.map((attachment, i) => (
                    <a
                      key={i}
                      href={attachment.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="block text-xs underline"
                    >
                      ðŸ“Ž {attachment.name}
                    </a>
                  ))}
                </div>
              )}
              <p className={cn(
                "text-xs mt-1",
                message.sender === variant ? "text-blue-100" : "text-gray-500"
              )}>
                {format(new Date(message.timestamp), 'h:mm a')}
              </p>
            </div>
          </div>
        ))}
        {isTyping && (
          <div className="flex justify-start">
            <div className="bg-gray-100 rounded-lg px-3 py-2">
              <div className="flex space-x-1">
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" />
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }} />
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }} />
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Quick Replies */}
      <div className="p-3 border-b bg-gray-50">
        <p className="text-xs font-medium text-gray-600 mb-2">Quick replies:</p>
        <div className="flex flex-wrap gap-1">
          {quickReplies.map((reply, index) => (
            <Button
              key={index}
              variant="outline"
              size="sm"
              className="text-xs h-6"
              onClick={() => setNewMessage(reply)}
            >
              {reply}
            </Button>
          ))}
        </div>
      </div>

      {/* Message Input */}
      <div className="p-4 space-y-3">
        <div className="flex gap-2">
          <Input
            value={newMessage}
            onChange={(e) => setNewMessage(e.target.value)}
            placeholder="Type your message..."
            onKeyDown={(e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault()
                handleSendMessage()
              }
            }}
            className="flex-1"
          />
          <Button
            type="button"
            variant="outline"
            size="icon"
            onClick={() => document.getElementById(`file-upload-${order._id}`)?.click()}
          >
            <Paperclip className="w-4 h-4" />
          </Button>
          <Button onClick={handleSendMessage} disabled={!newMessage.trim() && attachments.length === 0}>
            <Send className="w-4 h-4" />
          </Button>
        </div>

        <input
          id={`file-upload-${order._id}`}
          type="file"
          multiple
          className="hidden"
          onChange={(e) => {
            if (e.target.files) {
              setAttachments(Array.from(e.target.files))
            }
          }}
        />

        {attachments.length > 0 && (
          <div className="flex flex-wrap gap-2">
            {attachments.map((file, index) => (
              <Badge key={index} variant="secondary" className="text-xs">
                {file.name}
                <button
                  onClick={() => setAttachments(prev => prev.filter((_, i) => i !== index))}
                  className="ml-1 text-red-500"
                >
                  Ã—
                </button>
              </Badge>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
```

### Real-Time Updates System
**WebSocket/SSE Implementation:**
```typescript
// /api/orders/[id]/stream/route.ts
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const session = await auth()
  if (!session?.user) {
    return new Response('Unauthorized', { status: 401 })
  }

  const orderId = params.id
  const order = await Order.findById(orderId)
  
  if (!order) {
    return new Response('Order not found', { status: 404 })
  }

  // Verify user has access to this order
  const hasAccess = 
    order.customer.userId.toString() === session.user.id ||
    order.printShop.shopId.toString() === session.user.id ||
    session.user.role === 'admin'

  if (!hasAccess) {
    return new Response('Forbidden', { status: 403 })
  }

  const encoder = new TextEncoder()
  
  const stream = new ReadableStream({
    start(controller) {
      // Send initial connection event
      const data = `data: ${JSON.stringify({ type: 'connected', timestamp: new Date() })}\n\n`
      controller.enqueue(encoder.encode(data))

      // Set up MongoDB change stream
      const changeStream = Order.watch([
        { $match: { 'fullDocument._id': new ObjectId(orderId) } }
      ])

      changeStream.on('change', (change) => {
        if (change.operationType === 'update') {
          const data = `data: ${JSON.stringify({
            type: 'status_change',
            order: change.fullDocument,
            timestamp: new Date()
          })}\n\n`
          controller.enqueue(encoder.encode(data))
        }
      })

      // Set up message notifications
      const messageStream = OrderMessage.watch([
        { $match: { 'fullDocument.orderId': new ObjectId(orderId) } }
      ])

      messageStream.on('change', (change) => {
        if (change.operationType === 'insert') {
          const data = `data: ${JSON.stringify({
            type: 'new_message',
            message: change.fullDocument,
            timestamp: new Date()
          })}\n\n`
          controller.enqueue(encoder.encode(data))
        }
      })

      // Cleanup on close
      request.signal.addEventListener('abort', () => {
        changeStream.close()
        messageStream.close()
        controller.close()
      })
    }
  })

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  })
}
```

### Issue Reporting System
**Quality Issue Reporting:**
```typescript
// components/orders/issue-reporting.tsx
interface IssueReportingProps {
  order: Order
  onIssueReported: (issue: OrderIssue) => void
}

export function IssueReporting({ order, onIssueReported }: IssueReportingProps) {
  const [issueType, setIssueType] = useState('')
  const [description, setDescription] = useState('')
  const [photos, setPhotos] = useState<File[]>([])
  const [isSubmitting, setIsSubmitting] = useState(false)

  const issueTypes = [
    { value: 'print_quality', label: 'Print Quality Issue', description: 'Blurry, faded, or poor quality printing' },
    { value: 'wrong_specifications', label: 'Wrong Specifications', description: 'Wrong paper size, color, or binding' },
    { value: 'incomplete_order', label: 'Incomplete Order', description: 'Missing pages or items' },
    { value: 'damaged_product', label: 'Damaged Product', description: 'Physical damage during printing or handling' },
    { value: 'late_delivery', label: 'Late Delivery', description: 'Order completed after promised time' },
    { value: 'other', label: 'Other', description: 'Other issues not listed above' }
  ]

  const handleSubmitIssue = async () => {
    if (!issueType || !description.trim()) return

    setIsSubmitting(true)
    try {
      const formData = new FormData()
      formData.append('orderId', order._id)
      formData.append('issueType', issueType)
      formData.append('description', description)
      
      photos.forEach((photo, index) => {
        formData.append(`photo${index}`, photo)
      })

      const response = await fetch('/api/orders/report-issue', {
        method: 'POST',
        body: formData
      })

      if (response.ok) {
        const issue = await response.json()
        onIssueReported(issue)
        
        // Reset form
        setIssueType('')
        setDescription('')
        setPhotos([])
      }
    } catch (error) {
      console.error('Failed to report issue:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className="space-y-6">
      <div>
        <h3 className="font-semibold mb-2">Report an Issue</h3>
        <p className="text-sm text-muted-foreground">
          Let us know if there's a problem with your order
        </p>
      </div>

      {/* Issue Type Selection */}
      <div className="space-y-3">
        <Label className="text-sm font-medium">What type of issue are you experiencing?</Label>
        <RadioGroup value={issueType} onValueChange={setIssueType}>
          {issueTypes.map((type) => (
            <div key={type.value} className="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value={type.value} id={type.value} className="mt-1" />
              <div className="flex-1">
                <Label htmlFor={type.value} className="font-medium cursor-pointer">
                  {type.label}
                </Label>
                <p className="text-sm text-muted-foreground mt-1">
                  {type.description}
                </p>
              </div>
            </div>
          ))}
        </RadioGroup>
      </div>

      {/* Description */}
      <div className="space-y-2">
        <Label htmlFor="description">Describe the issue in detail</Label>
        <Textarea
          id="description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          placeholder="Please provide as much detail as possible about the issue..."
          className="min-h-[100px]"
        />
      </div>

      {/* Photo Upload */}
      <div className="space-y-2">
        <Label>Photos (optional but helpful)</Label>
        <div
          className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gray-400"
          onClick={() => document.getElementById('issue-photos')?.click()}
        >
          <Camera className="w-8 h-8 mx-auto text-gray-400 mb-2" />
          <p className="text-sm text-gray-600">
            Click to upload photos of the issue
          </p>
          <p className="text-xs text-gray-500 mt-1">
            PNG, JPG up to 10MB each
          </p>
        </div>
        <input
          id="issue-photos"
          type="file"
          multiple
          accept="image/*"
          className="hidden"
          onChange={(e) => {
            if (e.target.files) {
              setPhotos(Array.from(e.target.files))
            }
          }}
        />
        
        {photos.length > 0 && (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3">
            {photos.map((photo, index) => (
              <div key={index} className="relative">
                <img
                  src={URL.createObjectURL(photo)}
                  alt={`Issue photo ${index + 1}`}
                  className="w-full h-20 object-cover rounded border"
                />
                <button
                  onClick={() => setPhotos(prev => prev.filter((_, i) => i !== index))}
                  className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs"
                >
                  Ã—
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Submit Button */}
      <Button
        onClick={handleSubmitIssue}
        disabled={!issueType || !description.trim() || isSubmitting}
        className="w-full"
      >
        {isSubmitting ? 'Submitting Issue...' : 'Submit Issue Report'}
      </Button>
    </div>
  )
}
```

### Pickup/Delivery Coordination
**Smart Coordination System:**
```typescript
// components/orders/pickup-delivery.tsx
export function PickupDeliveryCoordination({ order }: { order: Order }) {
  const [qrCode, setQrCode] = useState<string>('')

  useEffect(() => {
    if (order.status === 'ready') {
      generatePickupQRCode(order._id).then(setQrCode)
    }
  }, [order.status, order._id])

  if (order.delivery.method === 'pickup') {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <MapPin className="w-5 h-5" />
            Pickup Information
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <h4 className="font-medium">Print Shop Location</h4>
            <p className="text-sm text-muted-foreground">
              {order.printShop.businessInfo.location.address}
            </p>
            <Button variant="link" className="p-0 h-auto" asChild>
              <a
                href={`https://maps.google.com/?q=${encodeURIComponent(order.printShop.businessInfo.location.address)}`}
                target="_blank"
                rel="noopener noreferrer"
              >
                Get Directions
              </a>
            </Button>
          </div>

          <div>
            <h4 className="font-medium">Business Hours</h4>
            <div className="text-sm text-muted-foreground">
              {Object.entries(order.printShop.businessInfo.hours).map(([day, hours]) => (
                <div key={day} className="flex justify-between">
                  <span>{day}:</span>
                  <span>{hours.open} - {hours.close}</span>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h4 className="font-medium">Contact Information</h4>
            <p className="text-sm text-muted-foreground">
              Phone: {order.printShop.businessInfo.contact.phone}
            </p>
          </div>

          {order.status === 'ready' && qrCode && (
            <div className="text-center">
              <h4 className="font-medium mb-2">Pickup QR Code</h4>
              <img src={qrCode} alt="Pickup QR Code" className="mx-auto w-32 h-32" />
              <p className="text-xs text-muted-foreground mt-2">
                Show this code at pickup
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Truck className="w-5 h-5" />
          Delivery Information
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <h4 className="font-medium">Delivery Address</h4>
          <p className="text-sm text-muted-foreground">
            {order.delivery.address?.street}<br />
            {order.delivery.address?.city}, {order.delivery.address?.state} {order.delivery.address?.zipCode}
          </p>
        </div>

        {order.delivery.timeSlot && (
          <div>
            <h4 className="font-medium">Delivery Window</h4>
            <p className="text-sm text-muted-foreground">
              {format(new Date(order.delivery.timeSlot.date), 'PPP')} between{' '}
              {order.delivery.timeSlot.startTime} - {order.delivery.timeSlot.endTime}
            </p>
          </div>
        )}

        {order.delivery.instructions && (
          <div>
            <h4 className="font-medium">Special Instructions</h4>
            <p className="text-sm text-muted-foreground">
              {order.delivery.instructions}
            </p>
          </div>
        )}

        <div>
          <h4 className="font-medium">Delivery Fee</h4>
          <p className="text-sm text-muted-foreground">
            ${order.delivery.cost.toFixed(2)}
          </p>
        </div>
      </CardContent>
    </Card>
  )
}
```

### File Locations and Project Structure
- **Tracking Pages**: `/app/orders/[id]/page.tsx`, `/app/orders/history/page.tsx`
- **Tracking Components**: `/components/orders/order-tracker.tsx`, `/components/orders/order-communication.tsx`
- **Issue Reporting**: `/components/orders/issue-reporting.tsx`
- **API Routes**: `/app/api/orders/[id]/stream/`, `/app/api/orders/communicate/`, `/app/api/orders/report-issue/`
- **Real-time Utils**: `/lib/realtime/order-events.ts`

## Testing

### Test Requirements
**Order Tracking Testing:**
```typescript
// __tests__/components/orders/order-tracker.test.tsx
describe('OrderTracker', () => {
  it('displays correct status progress', () => {
    const order = { ...mockOrder, status: 'in_progress' }
    render(<OrderTracker order={order} />)
    
    expect(screen.getByText('Order Placed')).toBeInTheDocument()
    expect(screen.getByText('Order Accepted')).toBeInTheDocument()
    expect(screen.getByText('Printing')).toBeInTheDocument()
    
    // Current status should be highlighted
    expect(screen.getByText('Printing').closest('div')).toHaveClass('ring-4')
  })

  it('handles real-time status updates', async () => {
    const order = { ...mockOrder, status: 'accepted' }
    render(<OrderTracker order={order} />)
    
    // Simulate real-time update
    act(() => {
      window.dispatchEvent(new MessageEvent('message', {
        data: JSON.stringify({
          type: 'status_change',
          order: { ...order, status: 'in_progress' }
        })
      }))
    })

    await waitFor(() => {
      expect(screen.getByText('Printing').closest('div')).toHaveClass('ring-4')
    })
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation from Epic 2 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_