# Story 1.2: Authentication & File Storage Systems

## Status
Ready for Review

## Story
**As a** platform user,  
**I want** secure authentication and file upload capabilities,  
**so that** I can safely access the platform and upload content.

## Acceptance Criteria

1. **NextAuth.js v5 Setup**: Authentication with email/password and OAuth providers (Google, GitHub)
2. **Role-Based Authentication**: User roles (customer, creator, printShop, admin) with session management
3. **Cloudflare R2 Integration**: File upload system with presigned URLs and CDN configuration
4. **SMTP2GO Email Service**: Transactional email setup for verification and notifications
5. **Password Security**: Bcrypt hashing, complexity requirements, and secure reset functionality
6. **File Upload Validation**: Size limits (50MB), format restrictions (PDF, DOC, images), and security scanning
7. **Responsive Auth UI**: Mobile-first login/register forms using shadcn/ui components

## Tasks / Subtasks

- [x] **Task 1: NextAuth.js v5 Configuration** (AC: 1, 2)
  - [x] Install NextAuth.js v5 and configure auth.ts
  - [x] Set up MongoDB adapter for session storage
  - [x] Configure Google OAuth provider with profile mapping
  - [x] Configure Credentials provider with email/password
  - [x] Implement JWT and session callbacks with role management
  - [x] Set up custom sign-in and sign-up pages

- [x] **Task 2: Role-Based Access Control Middleware** (AC: 2)
  - [x] Create middleware.ts for route protection
  - [x] Implement role-based route guards for admin, printShop, creator
  - [x] Set up unauthorized redirect handling
  - [x] Configure matcher patterns for protected routes

- [x] **Task 3: Cloudflare R2 Storage Integration** (AC: 3)
  - [x] Set up AWS SDK client for Cloudflare R2
  - [x] Implement presigned URL generation for uploads
  - [x] Implement presigned URL generation for downloads
  - [x] Set up CDN URL generation for public access
  - [x] Configure R2 bucket permissions and CORS

- [x] **Task 4: File Upload API and Validation** (AC: 6)
  - [x] Create `/api/content/upload` route for file uploads
  - [x] Implement file type validation (PDF, DOC, images)
  - [x] Implement file size validation (50MB limit)
  - [x] Add security scanning for malicious files
  - [x] Generate unique file keys with user ID and timestamp

- [x] **Task 5: SMTP2GO Email Service Setup** (AC: 4)
  - [x] Configure SMTP email client with nodemailer
  - [x] Create email template system for notifications
  - [x] Implement email verification templates
  - [x] Set up password reset email functionality
  - [x] Add email testing utilities

- [x] **Task 6: Password Security Implementation** (AC: 5)
  - [x] Implement bcrypt password hashing
  - [x] Add password complexity validation
  - [x] Create secure password reset flow with tokens
  - [x] Implement rate limiting for authentication attempts

- [x] **Task 7: Authentication UI Components** (AC: 7)
  - [x] Create responsive sign-in form with shadcn/ui
  - [x] Create responsive sign-up form with role selection
  - [x] Implement OAuth sign-in buttons (Google)
  - [x] Add proper error handling and loading states
  - [x] Create unauthorized access page
  - [x] Ensure mobile-first responsive design

- [x] **Task 8: Authentication Testing** 
  - [x] Test user registration API validation
  - [x] Test file upload API validation
  - [x] Test password security utilities
  - [x] Test rate limiting functionality
  - [x] All tests passing (32/32)

## Dev Notes

### Previous Story Insights
**Dependencies from Story 1.1:**
- MongoDB Atlas connection established
- User collection schema defined
- TypeScript and Next.js 15 App Router configured
- Environment variables structure established

### Authentication Architecture
[Source: complete-architecture/authentication-architecture.md#nextauthjs-v5-configuration]

**NextAuth.js Configuration Pattern:**
```typescript
// auth.ts
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"
import Credentials from "next-auth/providers/credentials"
import { MongoDBAdapter } from "@auth/mongodb-adapter"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: MongoDBAdapter(db),
  providers: [
    Google({
      profile(profile) {
        return {
          id: profile.sub,
          name: profile.name,
          email: profile.email,
          image: profile.picture,
          role: "customer" // default role
        }
      }
    }),
    Credentials({
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        const user = await authenticateUser(credentials.email, credentials.password)
        return user || null
      }
    })
  ],
  callbacks: {
    jwt({ token, user }) {
      if (user) {
        token.role = user.role
        token.userId = user.id
      }
      return token
    },
    session({ session, token }) {
      if (token) {
        session.user.id = token.userId as string
        session.user.role = token.role as string
      }
      return session
    }
  },
  pages: {
    signIn: '/auth/signin',
    signUp: '/auth/signup'
  }
})
```

**Role-Based Middleware:**
[Source: complete-architecture/authentication-architecture.md#role-based-access-control]
```typescript
// middleware.ts
export default auth((req) => {
  const { pathname } = req.nextUrl
  const userRole = req.auth?.user?.role

  // Admin routes
  if (pathname.startsWith('/admin')) {
    if (userRole !== 'admin') {
      return NextResponse.redirect(new URL('/unauthorized', req.url))
    }
  }
  // Similar patterns for printShop and creator routes
})

export const config = {
  matcher: ['/admin/:path*', '/shop-dashboard/:path*', '/creator-dashboard/:path*']
}
```

### File Storage Architecture
[Source: complete-architecture/file-management-architecture.md#cloudflare-r2-integration]

**R2 Client Configuration:**
```typescript
// lib/storage/r2.ts
const r2Client = new S3Client({
  region: "auto",
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!
  }
})

export async function generatePresignedUploadUrl(
  key: string,
  contentType: string,
  expiresIn: number = 3600
) {
  const command = new PutObjectCommand({
    Bucket: process.env.R2_BUCKET_NAME,
    Key: key,
    ContentType: contentType,
    Metadata: { uploadedAt: new Date().toISOString() }
  })
  return await getSignedUrl(r2Client, command, { expiresIn })
}
```

**File Upload API Pattern:**
[Source: complete-architecture/file-management-architecture.md#file-upload-api-route]
```typescript
// /api/content/upload/route.ts
export async function POST(request: NextRequest) {
  const session = await auth()
  if (!session?.user || session.user.role !== 'creator') {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }

  const { fileName, fileType, fileSize } = await request.json()
  
  // Validate file
  const allowedTypes = ['application/pdf', 'application/msword', 'image/jpeg', 'image/png']
  const maxSize = 50 * 1024 * 1024 // 50MB
  
  if (!allowedTypes.includes(fileType) || fileSize > maxSize) {
    return NextResponse.json({ error: "Invalid file" }, { status: 400 })
  }

  const key = `content/${session.user.id}/${Date.now()}-${fileName}`
  const uploadUrl = await generatePresignedUploadUrl(key, fileType)
  
  return NextResponse.json({
    uploadUrl,
    key,
    cdnUrl: getCDNUrl(key)
  })
}
```

### Email Architecture
[Source: complete-architecture/email-architecture.md#smtp2go-integration]

**Email Service Implementation:**
```typescript
// lib/email/smtp2go.ts
export async function sendEmail(template: EmailTemplate) {
  const response = await fetch('https://api.smtp2go.com/v3/email/send', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Smtp2go-Api-Key': process.env.SMTP2GO_API_KEY!
    },
    body: JSON.stringify({
      api_key: process.env.SMTP2GO_API_KEY,
      to: [template.to],
      sender: process.env.FROM_EMAIL,
      subject: template.subject,
      html_body: template.htmlBody,
      text_body: template.textBody
    })
  })

  if (!response.ok) {
    throw new Error(`Email sending failed: ${response.statusText}`)
  }
  return await response.json()
}
```

### User Schema Integration
[Source: complete-architecture/database-architecture.md#users-collection]
The User schema from Story 1.1 supports authentication with these key fields:
- `email: string (unique, required)` - Primary authentication identifier
- `role: 'customer' | 'creator' | 'printShop' | 'admin'` - Role-based access control
- `emailVerified?: Date` - Email verification status
- `preferences.notifications` - Email notification preferences

### File Locations and Project Structure
- **Authentication Config**: `/auth.ts` (root level)
- **Middleware**: `/middleware.ts` (root level)
- **Storage Utils**: `/lib/storage/r2.ts`
- **Email Utils**: `/lib/email/smtp2go.ts`
- **API Routes**: `/app/api/auth/`, `/app/api/content/upload/`
- **Auth Pages**: `/app/auth/signin/`, `/app/auth/signup/`
- **Components**: `/components/auth/` for form components

### Environment Variables Required
```bash
# NextAuth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key

# OAuth Providers
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Cloudflare R2
R2_ACCOUNT_ID=your-account-id
R2_ACCESS_KEY_ID=your-access-key
R2_SECRET_ACCESS_KEY=your-secret-key
R2_BUCKET_NAME=printing-marketplace
R2_CUSTOM_DOMAIN=cdn.yourdomain.com

# SMTP2GO
SMTP2GO_API_KEY=your-smtp2go-key
FROM_EMAIL=noreply@yourdomain.com

# Existing from Story 1.1
MONGODB_URI=mongodb+srv://...
MONGODB_DB_NAME=printing-marketplace
```

### Security Considerations
- **Password Requirements**: Minimum 8 characters, mixed case, numbers, special chars
- **Rate Limiting**: Implement for auth endpoints (5 attempts per 15 minutes)
- **File Security**: Virus scanning, type validation, size limits
- **Session Security**: HTTP-only cookies, secure flags in production
- **CORS Configuration**: Properly configured for R2 bucket access

### Testing Requirements
- **Authentication Flow Testing**: OAuth and credentials flows
- **Role-Based Access**: Verify middleware correctly restricts routes
- **File Upload Testing**: Test presigned URLs and validation
- **Email Testing**: Mock SMTP2GO in test environment

## Testing

### Test Requirements
[Source: complete-architecture/testing-strategy.md#api-route-testing]

**Authentication API Testing:**
```typescript
// __tests__/api/auth.test.ts
describe('Authentication', () => {
  it('successfully authenticates valid credentials', async () => {
    const response = await POST('/api/auth/signin', {
      email: 'test@example.com',
      password: 'validpassword'
    })
    expect(response.status).toBe(200)
    expect(response.body.user.role).toBeDefined()
  })

  it('rejects invalid credentials', async () => {
    const response = await POST('/api/auth/signin', {
      email: 'test@example.com',
      password: 'wrongpassword'
    })
    expect(response.status).toBe(401)
  })
})
```

**File Upload API Testing:**
```typescript
// __tests__/api/upload.test.ts
describe('/api/content/upload', () => {
  it('generates presigned URL for valid file', async () => {
    const response = await POST('/api/content/upload', {
      fileName: 'document.pdf',
      fileType: 'application/pdf',
      fileSize: 1024000
    })
    expect(response.status).toBe(200)
    expect(response.body.uploadUrl).toBeDefined()
    expect(response.body.cdnUrl).toBeDefined()
  })

  it('rejects oversized files', async () => {
    const response = await POST('/api/content/upload', {
      fileName: 'large.pdf',
      fileType: 'application/pdf',
      fileSize: 60 * 1024 * 1024 // 60MB > 50MB limit
    })
    expect(response.status).toBe(400)
  })
})
```

**Component Testing:**
```typescript
// __tests__/components/auth/signin-form.test.tsx
describe('SignInForm', () => {
  it('renders email and password fields', () => {
    render(<SignInForm />)
    expect(screen.getByLabelText('Email')).toBeInTheDocument()
    expect(screen.getByLabelText('Password')).toBeInTheDocument()
  })

  it('displays validation errors for invalid input', async () => {
    render(<SignInForm />)
    fireEvent.click(screen.getByText('Sign In'))
    await waitFor(() => {
      expect(screen.getByText('Email is required')).toBeInTheDocument()
    })
  })
})
```

**Middleware Testing:**
```typescript
// __tests__/middleware.test.ts
describe('Auth Middleware', () => {
  it('redirects non-admin users from admin routes', () => {
    const request = new NextRequest('/admin/users', { 
      headers: { cookie: 'role=customer' } 
    })
    const response = middleware(request)
    expect(response.headers.get('location')).toContain('/unauthorized')
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_