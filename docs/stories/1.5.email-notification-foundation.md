# Story 1.5: Email Notification Foundation

## Status
Draft

## Story
**As a** platform user,  
**I want** to receive email notifications for important platform events,  
**so that** I stay informed about orders, account changes, and platform updates.

## Acceptance Criteria

1. **Email Template System**: Responsive HTML email templates for different notification types
2. **SMTP2GO Integration**: Reliable email delivery with bounce handling and delivery tracking
3. **Notification Types**: Welcome emails, email verification, password reset, and system notifications
4. **Email Queue System**: Background email processing to prevent blocking user interactions
5. **Unsubscribe Management**: One-click unsubscribe with granular notification preferences
6. **Admin Email Tools**: Admin notifications for new user registrations and system events
7. **Testing Framework**: Email testing in development environment with email capture and preview

## Tasks / Subtasks

- [ ] **Task 1: SMTP2GO Service Integration** (AC: 2)
  - [ ] Set up SMTP2GO API client with authentication
  - [ ] Configure email sending service with error handling
  - [ ] Implement bounce and delivery tracking
  - [ ] Add email sending rate limiting and retry logic
  - [ ] Configure sender domain and authentication

- [ ] **Task 2: Email Template System** (AC: 1)
  - [ ] Create responsive HTML email template base layout
  - [ ] Design welcome email template for new users
  - [ ] Create email verification template with action button
  - [ ] Design password reset template with secure link
  - [ ] Create system notification template for updates

- [ ] **Task 3: Core Notification Types** (AC: 3)
  - [ ] Implement welcome email for new user registration
  - [ ] Create email verification flow with token generation
  - [ ] Build password reset email with secure token system
  - [ ] Add profile verification emails for print shops
  - [ ] Create system maintenance and update notifications

- [ ] **Task 4: Email Queue and Background Processing** (AC: 4)
  - [ ] Set up email queue system for background processing
  - [ ] Implement job processing for email delivery
  - [ ] Add email retry logic for failed deliveries
  - [ ] Create email status tracking and logging
  - [ ] Implement priority levels for different email types

- [ ] **Task 5: Subscription Management** (AC: 5)
  - [ ] Create unsubscribe link generation system
  - [ ] Build unsubscribe landing page with preferences
  - [ ] Implement granular notification preferences
  - [ ] Add subscription management API endpoints
  - [ ] Create email preference dashboard for users

- [ ] **Task 6: Admin Email System** (AC: 6)
  - [ ] Set up admin notification emails for new registrations
  - [ ] Create admin alerts for system events and errors
  - [ ] Implement business verification status emails
  - [ ] Add weekly/monthly admin summary emails
  - [ ] Create emergency notification system for admins

- [ ] **Task 7: Development Testing Framework** (AC: 7)
  - [ ] Set up email capture in development environment
  - [ ] Create email preview interface for template testing
  - [ ] Implement email testing utilities and mocks
  - [ ] Add email template validation and rendering tests
  - [ ] Create automated email delivery testing

- [ ] **Task 8: Email System Testing**
  - [ ] Test all email templates across email clients
  - [ ] Test email delivery and bounce handling
  - [ ] Test unsubscribe and preference management
  - [ ] Test queue processing and retry logic
  - [ ] Verify email deliverability and spam scores

## Dev Notes

### Previous Story Insights
**Dependencies from Previous Stories:**
- Story 1.1: MongoDB user collection with email preferences
- Story 1.2: SMTP2GO service configuration and API setup
- Story 1.3: Registration flow requiring email verification
- Story 1.4: Admin interfaces requiring notification systems

### Email Architecture Foundation
[Source: complete-architecture/email-architecture.md#smtp2go-integration]

**SMTP2GO Client Configuration:**
```typescript
// lib/email/smtp2go.ts
interface EmailTemplate {
  to: string
  subject: string
  htmlBody: string
  textBody?: string
  customHeaders?: Record<string, string>
}

export async function sendEmail(template: EmailTemplate) {
  const response = await fetch('https://api.smtp2go.com/v3/email/send', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Smtp2go-Api-Key': process.env.SMTP2GO_API_KEY!
    },
    body: JSON.stringify({
      api_key: process.env.SMTP2GO_API_KEY,
      to: [template.to],
      sender: process.env.FROM_EMAIL,
      subject: template.subject,
      html_body: template.htmlBody,
      text_body: template.textBody,
      custom_headers: template.customHeaders
    })
  })

  if (!response.ok) {
    throw new Error(`Email sending failed: ${response.statusText}`)
  }
  return await response.json()
}
```

**Email Template System:**
```typescript
// lib/email/templates.ts
export const emailTemplates = {
  welcome: (user: User) => ({
    subject: `Welcome to Printing Marketplace, ${user.name}!`,
    htmlBody: `
      <h1>Welcome to Printing Marketplace!</h1>
      <p>Hi ${user.name},</p>
      <p>Thanks for joining our platform. You're now part of a community connecting students, creators, and print shops.</p>
      <div style="margin: 20px 0;">
        <a href="${process.env.NEXTAUTH_URL}/dashboard" 
           style="background-color: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
          Get Started
        </a>
      </div>
    `,
    textBody: `Welcome to Printing Marketplace! Visit ${process.env.NEXTAUTH_URL}/dashboard to get started.`
  }),

  emailVerification: (user: User, token: string) => ({
    subject: "Verify your email address",
    htmlBody: `
      <h1>Verify Your Email</h1>
      <p>Hi ${user.name},</p>
      <p>Please click the button below to verify your email address:</p>
      <div style="margin: 20px 0;">
        <a href="${process.env.NEXTAUTH_URL}/auth/verify-email?token=${token}" 
           style="background-color: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
          Verify Email
        </a>
      </div>
      <p>This link will expire in 24 hours.</p>
    `
  }),

  passwordReset: (user: User, token: string) => ({
    subject: "Reset your password",
    htmlBody: `
      <h1>Password Reset</h1>
      <p>Hi ${user.name},</p>
      <p>You requested a password reset. Click the button below to create a new password:</p>
      <div style="margin: 20px 0;">
        <a href="${process.env.NEXTAUTH_URL}/auth/reset-password?token=${token}" 
           style="background-color: #dc3545; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
          Reset Password
        </a>
      </div>
      <p>This link will expire in 1 hour. If you didn't request this, please ignore this email.</p>
    `
  })
}
```

### User Preferences Integration
[Source: complete-architecture/database-architecture.md#users-collection]

**Email Preference Schema Extension:**
```typescript
// Extending User interface for email preferences
interface User {
  // ... existing fields
  preferences: {
    notifications: {
      email: boolean
      orderUpdates: boolean
      marketing: boolean
      adminAlerts: boolean
      weeklyDigest: boolean
    }
    unsubscribeToken?: string
    unsubscribedAt?: Date
  }
}
```

### Email Queue System Architecture
**Queue Processing with Background Jobs:**
```typescript
// lib/email/queue.ts
interface EmailJob {
  id: string
  to: string
  template: string
  data: Record<string, any>
  priority: 'high' | 'normal' | 'low'
  attempts: number
  scheduledAt: Date
  status: 'pending' | 'processing' | 'completed' | 'failed'
}

export class EmailQueue {
  async addJob(emailJob: Omit<EmailJob, 'id' | 'attempts' | 'status'>) {
    const job: EmailJob = {
      ...emailJob,
      id: generateId(),
      attempts: 0,
      status: 'pending'
    }
    
    // Save to database
    await EmailJob.create(job)
    
    // Process immediately for high priority
    if (job.priority === 'high') {
      await this.processJob(job)
    }
    
    return job
  }

  async processJob(job: EmailJob) {
    try {
      job.status = 'processing'
      await EmailJob.updateOne({ id: job.id }, { status: 'processing' })
      
      const template = emailTemplates[job.template](job.data)
      await sendEmail({
        to: job.to,
        ...template
      })
      
      job.status = 'completed'
      await EmailJob.updateOne({ id: job.id }, { status: 'completed' })
    } catch (error) {
      job.attempts += 1
      job.status = job.attempts >= 3 ? 'failed' : 'pending'
      await EmailJob.updateOne({ id: job.id }, { 
        status: job.status,
        attempts: job.attempts 
      })
    }
  }
}
```

### Unsubscribe Management System
**Unsubscribe Token Generation:**
```typescript
// lib/email/unsubscribe.ts
import { generateToken } from '@/lib/utils/tokens'

export async function generateUnsubscribeToken(userId: string): Promise<string> {
  const token = generateToken()
  
  await User.updateOne(
    { _id: userId },
    { 'preferences.unsubscribeToken': token }
  )
  
  return token
}

export async function unsubscribeUser(token: string, preferences?: Partial<NotificationPreferences>) {
  const user = await User.findOne({ 'preferences.unsubscribeToken': token })
  
  if (!user) {
    throw new Error('Invalid unsubscribe token')
  }
  
  if (preferences) {
    // Granular unsubscribe - update specific preferences
    await User.updateOne(
      { _id: user._id },
      { 'preferences.notifications': { ...user.preferences.notifications, ...preferences } }
    )
  } else {
    // Complete unsubscribe
    await User.updateOne(
      { _id: user._id },
      { 
        'preferences.notifications.email': false,
        'preferences.unsubscribedAt': new Date()
      }
    )
  }
}
```

### Admin Notification System
**Admin Alert Templates:**
```typescript
// lib/email/admin-templates.ts
export const adminTemplates = {
  newUserRegistration: (user: User) => ({
    subject: `New ${user.role} registration - ${user.email}`,
    htmlBody: `
      <h2>New User Registration</h2>
      <p><strong>Email:</strong> ${user.email}</p>
      <p><strong>Role:</strong> ${user.role}</p>
      <p><strong>Registration Date:</strong> ${user.createdAt.toLocaleString()}</p>
      <a href="${process.env.NEXTAUTH_URL}/admin/users/${user._id}">View User</a>
    `
  }),

  businessVerificationRequest: (user: User) => ({
    subject: `Business verification request - ${user.profile?.businessInfo?.name}`,
    htmlBody: `
      <h2>Business Verification Request</h2>
      <p><strong>Business:</strong> ${user.profile?.businessInfo?.name}</p>
      <p><strong>Email:</strong> ${user.email}</p>
      <p><strong>Description:</strong> ${user.profile?.businessInfo?.description}</p>
      <a href="${process.env.NEXTAUTH_URL}/admin/verification/${user._id}">Review Documents</a>
    `
  }),

  systemError: (error: Error, context: string) => ({
    subject: `System Error Alert - ${context}`,
    htmlBody: `
      <h2>System Error Detected</h2>
      <p><strong>Context:</strong> ${context}</p>
      <p><strong>Error:</strong> ${error.message}</p>
      <p><strong>Time:</strong> ${new Date().toISOString()}</p>
      <pre>${error.stack}</pre>
    `
  })
}
```

### Development Testing Framework
**Email Testing in Development:**
```typescript
// lib/email/testing.ts
export class EmailTesting {
  private static emails: EmailTemplate[] = []

  static async captureEmail(template: EmailTemplate) {
    if (process.env.NODE_ENV === 'development') {
      this.emails.push({
        ...template,
        timestamp: new Date(),
        id: generateId()
      })
      console.log(`ðŸ“§ Email captured: ${template.subject} to ${template.to}`)
    }
  }

  static getCapturedEmails() {
    return this.emails
  }

  static clearCapturedEmails() {
    this.emails = []
  }

  static async previewEmail(templateName: string, data: any) {
    const template = emailTemplates[templateName](data)
    return {
      subject: template.subject,
      html: template.htmlBody,
      text: template.textBody,
      previewUrl: `/api/email/preview/${templateName}?data=${encodeURIComponent(JSON.stringify(data))}`
    }
  }
}
```

### File Locations and Project Structure
- **Email Service**: `/lib/email/smtp2go.ts`, `/lib/email/queue.ts`
- **Templates**: `/lib/email/templates.ts`, `/lib/email/admin-templates.ts`
- **Queue Jobs**: `/lib/email/queue.ts`, `/app/api/email/process/route.ts`
- **Unsubscribe**: `/app/unsubscribe/page.tsx`, `/app/api/email/unsubscribe/route.ts`
- **Email Preview**: `/app/api/email/preview/[template]/route.ts`
- **Testing Utils**: `/lib/email/testing.ts`, `/app/api/email/test/route.ts`

### API Routes Structure
```
/api/
â”œâ”€â”€ email/
â”‚   â”œâ”€â”€ send/route.ts            # Send individual email
â”‚   â”œâ”€â”€ queue/route.ts           # Add email to queue
â”‚   â”œâ”€â”€ unsubscribe/route.ts     # Handle unsubscribe requests
â”‚   â”œâ”€â”€ preferences/route.ts     # Update email preferences
â”‚   â”œâ”€â”€ preview/[template]/route.ts  # Preview email templates
â”‚   â””â”€â”€ test/route.ts            # Development email testing
```

### Environment Variables Required
```bash
# SMTP2GO Configuration
SMTP2GO_API_KEY=your-smtp2go-api-key
FROM_EMAIL=noreply@yourdomain.com
FROM_NAME="Printing Marketplace"

# Email Configuration
EMAIL_QUEUE_ENABLED=true
EMAIL_RETRY_ATTEMPTS=3
EMAIL_RATE_LIMIT=100  # emails per minute

# Admin Configuration
ADMIN_EMAIL=admin@yourdomain.com
SYSTEM_ALERT_EMAIL=alerts@yourdomain.com

# Development Testing
EMAIL_TESTING_MODE=capture  # capture | preview | send
EMAIL_PREVIEW_URL=http://localhost:3000/api/email/preview
```

### Email Deliverability Best Practices
- **SPF Record**: Configure sender policy framework
- **DKIM Signing**: Enable domain key signing
- **DMARC Policy**: Set up domain-based message authentication
- **Bounce Handling**: Process bounce notifications
- **List Hygiene**: Remove invalid email addresses
- **Content Guidelines**: Avoid spam trigger words and formatting

### Security Considerations
- **Token Security**: Time-limited tokens for verification and reset
- **Rate Limiting**: Prevent email abuse and spam
- **Unsubscribe Compliance**: One-click unsubscribe as required by law
- **Data Privacy**: Respect user preferences and GDPR requirements
- **Admin Alerts**: Secure admin email addresses

## Testing

### Test Requirements
[Source: complete-architecture/testing-strategy.md#api-route-testing]

**Email Service Testing:**
```typescript
// __tests__/lib/email/smtp2go.test.ts
describe('SMTP2GO Email Service', () => {
  it('sends email successfully with valid template', async () => {
    const mockResponse = { data: { email_id: '123' } }
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve(mockResponse)
    })

    const result = await sendEmail({
      to: 'test@example.com',
      subject: 'Test Email',
      htmlBody: '<h1>Test</h1>'
    })

    expect(result).toEqual(mockResponse)
    expect(fetch).toHaveBeenCalledWith(
      'https://api.smtp2go.com/v3/email/send',
      expect.objectContaining({
        method: 'POST',
        headers: expect.objectContaining({
          'X-Smtp2go-Api-Key': process.env.SMTP2GO_API_KEY
        })
      })
    )
  })

  it('throws error on failed email delivery', async () => {
    global.fetch = jest.fn().mockResolvedValue({
      ok: false,
      statusText: 'Bad Request'
    })

    await expect(sendEmail({
      to: 'invalid@email',
      subject: 'Test',
      htmlBody: 'Test'
    })).rejects.toThrow('Email sending failed: Bad Request')
  })
})
```

**Email Queue Testing:**
```typescript
// __tests__/lib/email/queue.test.ts
describe('Email Queue', () => {
  it('processes high priority emails immediately', async () => {
    const queue = new EmailQueue()
    const sendEmailSpy = jest.spyOn(emailService, 'sendEmail')

    await queue.addJob({
      to: 'test@example.com',
      template: 'welcome',
      data: { name: 'Test User' },
      priority: 'high',
      scheduledAt: new Date()
    })

    expect(sendEmailSpy).toHaveBeenCalled()
  })

  it('retries failed email jobs up to 3 times', async () => {
    const queue = new EmailQueue()
    jest.spyOn(emailService, 'sendEmail').mockRejectedValue(new Error('Send failed'))

    const job = await queue.addJob({
      to: 'test@example.com',
      template: 'welcome',
      data: { name: 'Test User' },
      priority: 'normal',
      scheduledAt: new Date()
    })

    // Process job 3 times
    await queue.processJob(job)
    await queue.processJob(job)
    await queue.processJob(job)

    expect(job.status).toBe('failed')
    expect(job.attempts).toBe(3)
  })
})
```

**Email Template Testing:**
```typescript
// __tests__/lib/email/templates.test.ts
describe('Email Templates', () => {
  it('generates welcome email with user data', () => {
    const user = { name: 'John Doe', email: 'john@example.com' }
    const template = emailTemplates.welcome(user)

    expect(template.subject).toContain('John Doe')
    expect(template.htmlBody).toContain('Hi John Doe')
    expect(template.htmlBody).toContain('/dashboard')
  })

  it('generates email verification with secure token', () => {
    const user = { name: 'Jane Doe', email: 'jane@example.com' }
    const token = 'secure-token-123'
    const template = emailTemplates.emailVerification(user, token)

    expect(template.htmlBody).toContain(`token=${token}`)
    expect(template.htmlBody).toContain('Verify Email')
  })
})
```

**Unsubscribe System Testing:**
```typescript
// __tests__/api/email/unsubscribe.test.ts
describe('/api/email/unsubscribe', () => {
  it('unsubscribes user with valid token', async () => {
    const user = await User.create({
      email: 'test@example.com',
      preferences: { unsubscribeToken: 'valid-token' }
    })

    const response = await POST('/api/email/unsubscribe', {
      token: 'valid-token'
    })

    expect(response.status).toBe(200)
    
    const updatedUser = await User.findById(user._id)
    expect(updatedUser.preferences.notifications.email).toBe(false)
  })

  it('rejects invalid unsubscribe token', async () => {
    const response = await POST('/api/email/unsubscribe', {
      token: 'invalid-token'
    })

    expect(response.status).toBe(400)
    expect(response.body.error).toContain('Invalid token')
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_